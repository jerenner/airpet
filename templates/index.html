<!DOCTYPE html>
<html>
<head>
    <title>GDML Viewer & Editor</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; overflow: hidden; display: flex; }
        #left_panel_container {
            width: 300px; /* Fixed width for now */
            height: 100vh;
            background-color: #e9e9e9; /* Slightly different background */
            border-right: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Tab Navigation */
        .tab_navigation {
            display: flex;
            border-bottom: 1px solid #ccc;
            background-color: #f8f8f8;
        }
        .tab_button {
            flex-grow: 1;
            padding: 8px 5px; /* Reduced padding for more tabs */
            cursor: pointer;
            border: none;
            border-right: 1px solid #ddd;
            background-color: #f0f0f0;
            font-size: 11px; /* Smaller font for tab buttons */
            text-align: center;
        }
        .tab_button:last-child {
            border-right: none;
        }
        .tab_button.active {
            background-color: #e9e9e9; /* Match panel bg */
            border-bottom: 1px solid #e9e9e9; /* Hide bottom border of active tab */
            font-weight: bold;
        }
        .tab_button:hover {
            background-color: #ddd;
        }

        /* Tab Content Area (will hold hierarchy_panel) */
        .tab_content_area {
            flex-grow: 1; /* Takes up available space for hierarchy */
            overflow-y: auto; /* Scroll within this area */
            background-color: #e9e9e9;
        }
        .tab_pane {
            display: none; /* Hidden by default */
            padding: 10px;
            font-size: 13px;
        }
        .tab_pane.active {
            display: block;
        }
        /* Hierarchy specific styles (same as before) */
        .tab_pane ul { list-style-type: none; padding-left: 15px; margin: 0; }
        .tab_pane li { padding: 3px 0; cursor: pointer; }
        .tab_pane li:hover { background-color: #d8d8d8; } /* Slightly darker hover */
        .tab_pane .selected_item { background-color: #c0d0e0; font-weight: bold; }
        .tab_pane .hidden_item { color: #999; font-style: italic; }
        .tab_pane .toggle { display: inline-block; width: 15px; text-align: center; margin-right: 3px;}

        #inspector_panel {
            height: 300px; /* Fixed height, or use flex-basis for proportions */
            /* flex-basis: 300px; /* Alternative to height if using flex for parent */
            /* flex-shrink: 0; /* Prevent shrinking if content is too much */
            overflow-y: auto;
            padding: 10px;
            border-top: 1px solid #ccc;
            background-color: #fdfdfd; /* Lighter inspector */
        }
        /* ... (inspector_panel h3, .property_item styles remain the same) ... */
        #inspector_panel h3 { margin-top: 0; font-size: 14px; border-bottom: 1px solid #bbb; padding-bottom: 5px;}
        #inspector_panel .property_item { margin-bottom: 8px; }
        #inspector_panel .property_item label {
            display: inline-block;
            width: 90px; /* Adjust as needed */
            font-weight: bold;
            font-size: 12px;
            vertical-align: top;
        }
        #inspector_panel .property_item input[type="text"],
        #inspector_panel .property_item input[type="number"] {
            width: calc(100% - 100px); /* Adjust based on label width */
            padding: 3px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
        }
        #inspector_panel button { margin-top: 5px; padding: 3px 8px; font-size: 11px;}


        #main_content_area {
            flex-grow: 1; /* Takes remaining width */
            height: 100vh;
            position: relative; /* For positioning menu bar and viewer */
        }
        #menu_bar { /* Now inside main_content_area */
            position: absolute; top: 0; left: 0; width: 100%;
            background-color: #333; color: white; padding: 0; z-index: 1000; display: flex;
        }
        #menu_bar ul { list-style-type: none; margin: 0; padding: 0; display: flex; }
        #menu_bar li { position: relative; }
        #menu_bar li > button, #menu_bar li > span {
            display: block; color: white; text-align: center; padding: 8px 12px;
            text-decoration: none; border: none; background-color: transparent;
            cursor: pointer; font-size: 14px;
        }
        #menu_bar li > button:hover, #menu_bar li .dropdown_content button:hover { background-color: #555; }
        #menu_bar .dropdown_content {
            display: none; position: absolute; background-color: #f9f9f9; min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1;
        }
        #menu_bar .dropdown_content button {
            color: black; padding: 10px 14px; text-decoration: none; display: block;
            text-align: left; width: 100%; border: none; background-color: transparent; cursor: pointer;
        }
        #menu_bar li:hover .dropdown_content { display: block; }
        #menu_bar button.active_mode { background-color: #007bff; color: white; }

        #viewer_container { /* Now relative within main_content_area */
            width: 100%; height: 100%;
            padding-top: 35px; /* Account for menu bar height */
            box-sizing: border-box;
        }
        canvas { display: block; width: 100% !important; height: 100% !important; }

    </style>
</head>
<body>
    <div id="left_panel_container">
        <div class="tab_navigation">
            <button class="tab_button active" data-tab="tab_structure">Structure</button>
            <button class="tab_button" data-tab="tab_defines">Defines</button>
            <button class="tab_button" data-tab="tab_materials">Materials</button>
            <button class="tab_button" data-tab="tab_solids">Solids</button>
        </div>
        <div class="tab_content_area">
            <div id="tab_structure" class="tab_pane active">
                <!-- Structure (Volumes) Hierarchy will be built here -->
                <ul id="structure_tree_root"></ul>
            </div>
            <div id="tab_defines" class="tab_pane">
                <ul id="defines_list_root"></ul>
            </div>
            <div id="tab_materials" class="tab_pane">
                <ul id="materials_list_root"></ul>
            </div>
            <div id="tab_solids" class="tab_pane">
                <ul id="solids_list_root"></ul>
            </div>
        </div>
        <div id="inspector_panel">
            <h3>Inspector</h3>
            <div id="inspector_content">
                <p>Select an item.</p>
            </div>
        </div>
    </div>
    <div id="main_content_area">
        <div id="menu_bar">
            <ul>
                <!-- File Menu -->
                <li>
                    <button>File</button>
                    <div class="dropdown_content">
                        <button id="loadGdmlButton">Load GDML...</button>
                        <input type="file" id="gdmlFile" accept=".gdml,.xml" style="display: none;">
                        <button id="exportGdmlButton">Export GDML...</button>
                        <hr style="margin: 5px 0;"> <!-- Separator -->
                        <button id="saveProjectButton">Save Project (JSON)...</button>
                        <button id="loadProjectButton">Load Project (JSON)...</button>
                        <input type="file" id="projectFile" accept=".json" style="display: none;">
                    </div>
                </li>
                <!-- Edit Menu -->
                <li>
                    <button>Edit</button>
                    <div class="dropdown_content">
                        <button id="toggleSnapToGridButton">Snap to Grid: OFF</button>
                        <div style="padding: 10px; font-size: 12px;">
                            Grid Snap (mm): <input type="number" id="gridSnapSizeInput" value="10" step="any" style="width: 60px;">
                            Angle Snap (deg): <input type="number" id="angleSnapSizeInput" value="1" step="any" style="width: 60px;">
                        </div>
                    </div>
                </li>
                <!-- View Menu -->
                <li>
                    <button>View</button>
                    <div class="dropdown_content">
                        <button id="toggleWireframeButton">Toggle Wireframe</button>
                        <button id="toggleGridButton">Toggle Grid</button>
                        <hr style="margin: 5px 0;"> <!-- Separator -->
                        <button id="cameraModeOrbitButton">Camera: Orbit</button>
                        <button id="cameraModeFlyButton">Camera: Fly</button>
                    </div>
                </li>
                <!-- Object Menu -->
                <li>
                    <button>Object</button>
                    <div class="dropdown_content">
                        <button id="addObjectButton">Add...</button> <!-- This could open a sub-menu or a dialog -->
                        <button id="deleteSelectedObjectButton">Delete Selected</button>
                    </div>
                </li>
                <!-- Mode Menu -->
                <li>
                    <button>Mode</button>
                    <div class="dropdown_content">
                        <button id="modeObserveButton" class="active_mode">Observe</button>
                        <button id="modeTranslateButton">Translate</button> <!-- Renamed from Move -->
                        <button id="modeRotateButton">Rotate</button>
                        <button id="modeScaleButton">Scale</button> <!-- Optional for future -->
                    </div>
                </li>
                <li><span id="currentModeDisplay" style="padding: 8px 12px; font-style: italic;">Mode: Observe</span></li>
            </ul>
        </div>
        <div id="viewer_container"></div>
        <!-- Old floating info panel -->
        <!--<div id="info_panel">
            <h3>Object Information</h3>
            <p><strong>Name:</strong> <span id="info_name">-</span></p>
            <p><strong>Type:</strong> <span id="info_type">-</span></p>
            <p><strong>Parameters:</strong></p>
            <div id="info_parameters" style="padding-left: 10px;">-</div>
            <p><strong>Position (mm):</strong></p>
            <div id="info_position" style="padding-left: 10px;">-</div>
            <p><strong>Rotation (rad, ZYX):</strong></p>
            <div id="info_rotation" style="padding-left: 10px;">-</div>
        </div>-->
        <div id="addObjectModal" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:white; padding:20px; border:1px solid #ccc; z-index:1001;">
            <h4>Add New Object</h4>
            <label for="newObjectType">Type:</label>
            <select id="newObjectType">
                <option value="define_position">Define: Position</option>
                <option value="define_rotation">Define: Rotation</option>
                <option value="material">Material</option>
                <option value="solid_box">Solid: Box</option>
                <option value="solid_tube">Solid: Tube</option>
                <!-- Add more solid types -->
                <option value="logical_volume" disabled>Logical Volume (select solid/mat)</option> <!-- Disabled for now -->
                <option value="physical_volume" disabled>Physical Volume (select LV/parent)</option> <!-- Disabled for now -->
            </select>
            <br><br>
            <label for="newObjectName">Name:</label>
            <input type="text" id="newObjectName" placeholder="e.g., MyNewBox">
            <br><br>
            <!-- Fields for parameters will be added dynamically by JS -->
            <div id="newObjectParams"></div>
            <br>
            <button id="confirmAddObject">Add</button>
            <button id="cancelAddObject">Cancel</button>
        </div>
        <div id="modalBackdrop" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;"></div>
    </div>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script type="module" src="{{ url_for('static', filename='main.js') }}"></script>
</body>
</html>